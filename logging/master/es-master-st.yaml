apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: es-master
  labels:
    app: "es-master"
spec:
  serviceName: es-master-headless
  selector:
    matchLabels:
      app: "es-master"
  replicas: 1
  podManagementPolicy: Parallel
  template:
    metadata:
      name: "es-master"
      labels:
        app: "es-master"
    spec:
      securityContext:
        fsGroup: 1000
        runAsUser: 1000
      # affinity:
      #   podAntiAffinity:
      #     requiredDuringSchedulingIgnoredDuringExecution:
      #     - labelSelector:
      #         matchExpressions:
      #         - key: app
      #           operator: In
      #           values:
      #           - "es-master"
      #       topologyKey: kubernetes.io/hostname
      terminationGracePeriodSeconds: 120

      initContainers:
      - name: configure-sysctl
        securityContext:
          runAsUser: 0
          privileged: true
        image: "elasticsearch:8.5.1"
        imagePullPolicy: "IfNotPresent"
        command: ["sysctl", "-w", "vm.max_map_count=262144"]
        resources: {}

      containers:
      - name: "elasticsearch"
        image: "elasticsearch:7.17.5"
        imagePullPolicy: "IfNotPresent"
        ports:
        - name: http
          containerPort: 9200
        - name: transport
          containerPort: 9300
        resources:
          requests: {}
          limits: {}
        env:
        - name: node.name
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: cluster.initial_master_nodes
          value: "es-master-0"
        - name: node.roles
          value: "master,"
        - name: discovery.seed_hosts
          value: "es-master-headless,es-client-headless,es-data-headless"
        - name: cluster.name
          value: "es"
        - name: network.host
          value: "0.0.0.0"
        - name: ELASTIC_PASSWORD
          valueFrom:
            secretKeyRef:
              name: es-credentials
              key: password
        - name: xpack.security.enabled
          value: "true"
        - name: xpack.security.transport.ssl.enabled
          value: "true"
        - name: xpack.security.http.ssl.enabled
          value: "true"
        - name: xpack.security.transport.ssl.verification_mode
          value: "certificate"
        - name: xpack.security.transport.ssl.key
          value: "/usr/share/elasticsearch/config/certs/tls.key"
        - name: xpack.security.transport.ssl.certificate
          value: "/usr/share/elasticsearch/config/certs/tls.crt"
        - name: xpack.security.transport.ssl.certificate_authorities
          value: "/usr/share/elasticsearch/config/certs/ca.crt"
        - name: xpack.security.http.ssl.key
          value: "/usr/share/elasticsearch/config/certs/tls.key"
        - name: xpack.security.http.ssl.certificate
          value: "/usr/share/elasticsearch/config/certs/tls.crt"
        - name: xpack.security.http.ssl.certificate_authorities
          value: "/usr/share/elasticsearch/config/certs/ca.crt"
        volumeMounts:
        - name: "es-master"
          mountPath: /usr/share/elasticsearch/data
        - name: elasticsearch-certs
          mountPath: /usr/share/elasticsearch/config/certs
          readOnly: true
      volumes:
      - name: elasticsearch-certs
        secret:
          secretName: es-certs
      - name: "es-master"
        emptyDir:
          medium: ""
